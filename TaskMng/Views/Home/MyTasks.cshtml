@model IEnumerable<TaskMng.Models.TaskView>

<p>
    <br />
    <a href="#" title="Create new task" data-toggle="modal" data-target="#myModalCreateTask">
        <i class="fas fa-plus-circle"></i>
        Create new task
    </a>
</p>

<table class="table">
    <tr>
        <th></th>
        <th>
            @Html.DisplayNameFor(model => model.Name)
        </th>
        <th>
            @Html.DisplayNameFor(model => model.Status)
        </th>
        <th>
            @Html.DisplayNameFor(model => model.Progress)
        </th>
        <th></th>
    </tr>

    @foreach (var item in Model)
    {
        <tr id="task@(item.Id)">
            <td>
                <a id="iconshow-subtask" href="#" title="Show subtasks" onclick="showSubtasks(@item.Id)">
                    <i class="far fa-plus-square"></i>@*//change on far-fa-minus when click*@
                </a>
                <a id="iconhide-subtask" href="#" title="Hide subtasks" class="collapse" onclick="hideSubtasks(@item.Id)">
                    <i class="far fa-minus-square"></i>
                </a>
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Name)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Status.Name)
            </td>
            <td>
                <div class="progress">
                    <div class="progress-bar progress-bar-striped active" role="progressbar"
                         aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width:@item.Progress%">
                        @item.Progress%
                    </div>
                </div>
            </td>
            <td>
                <a href="#" title="Details" onclick="details(@item.Id)" data-toggle="modal" data-target="#myModalDetailsTask">
                    <i class="fas fa-info-circle"></i>
                </a>
                <a href="#" title="Edit" onclick="editMainTask(@item.Id)" data-toggle="modal" data-target="#myModalEditMainTask">
                    <i class="far fa-edit"></i>
                </a>
                <a href="#" title="Delete" onclick="deleteTask(@item.Id)">
                    <i class="fas fa-trash"></i>
                </a>

            </td>
        </tr>
        //add component that will change with partial view???
    }

</table>

<div id="myModalCreateTask" class="modal fade" role="dialog" style="opacity:initial;">
    <div class="modal-dialog">
        <div class="modal-content" style="position:fixed">
            <div class="modal-header">
                <h5 class="modal-title">Create your own task</h5>
                <button class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="task-name">Name:</label>
                    <input type="text" class="form-control" id="newtask-name" required>
                </div>
                <div class="form-group">
                    <label for="comment-text">Comment:</label>
                    <textarea class="form-control" id="comment-text"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-default" data-dismiss="modal">Close</button>
                <button class="btn btn-primary" type="button" onclick="createMyMainTask()">Save task</button>
            </div>
        </div>
    </div>
</div>


<div id="myModalDetailsTask" class="modal fade" role="dialog" style="opacity:initial">
    <div class="modal-dialog">
        <div class="modal-content" style="position:fixed">
            <div class="modal-header">
                <h5 class="modal-title">Details of Task </h5>
                <button class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="detailOfTask">

                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<div id="myModalEditMainTask" class="modal fade" role="dialog" style="opacity:initial">
    <div class="modal-dialog">
        <div class="modal-content" style="position:fixed">
            <div class="modal-header">
                <h5 class="modal-title">Edit Task</h5>
                <button class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="editTask">

                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-default" data-dismiss="modal">Close</button>
                <button class="btn btn-primary" type="button" >Save task</button>
            </div>
        </div>
    </div>
</div>



    <script>

        function editMainTask(taskId) {
             $.ajax({
                url: "@Url.Action("EditTask", "Home")",
                 method: "POST",
                 data: { id: taskId },
             })
                 .done(function (data) {
                $("#editTask").html(data) ;
            })
            .fail(function () {
                alert("Cannot find the task");
            });
        }

        function details(mainId) {
             $.ajax({
                url: "@Url.Action("Details", "Home")",
                 method: "GET",
                 data: { id: mainId },
             })
            .done(function (data) {
               $("#detailOfTask").html(data) ;
            })
            .fail(function () {
                alert("Cannot find the task");
            });
        }

        function createMyMainTask() {
            var task = {
                name : $("#newtask-name").val(),
                assigneeId : "",
                comment : $("#comment-text").val()
            };
            $.ajax({
                url: "@Url.Action("CreateTask", "Home")",
                method: "POST",
                data: { newTask: task }
            })
            .done(function () {
                alert("Task has been added.");
                top.location.href = '/Home/Index'
            })
            .fail(function () {
                alert("Cannot add the task!");
            });
        }

        function deleteTask(taskId) {
            $.ajax({
                url: "@Url.Action("DeleteTask", "Home")",
                method: "POST",
                data: { id: taskId }
            })
            .done(function () {
                alert("Task has been deleted.");
                $("#task" + taskId).remove();
            })
            .fail(function () {
                alert("Cannot delete the task!");
            });
        }

        function showSubtasks(taskId) {
            $.ajax({
                url: "@Url.Action("ShowSubtask", "Home")",
                method: "GET",
                data: { parentId: taskId }
            })
                .done(function (data) {
                    var taskRow = $('#task' + taskId);
                    taskRow.after(data);

                    $("#iconshow-subtask", taskRow).hide();
                    $("#iconhide-subtask", taskRow).show();
            })
            .fail(function () {
                //alert("Cannot delete the task!");
            });
        }

        function hideSubtasks(taskId) {
            var taskRow = $('#task' + taskId);
            taskRow.next().remove();
            $("#iconhide-subtask", taskRow).hide();
            $("#iconshow-subtask", taskRow).show();
        }
    </script>
